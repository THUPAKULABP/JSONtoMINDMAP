<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html b:css='false' b:defaultwidgetversion='2' b:layoutsVersion='3' b:responsive='true' b:version='2' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' name='viewport'/>
  <title><data:blog.pageTitle/></title>
  
  <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;family=Outfit:wght@500;700&amp;display=swap' rel='stylesheet'/>
  
  <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js'></script>

  <b:skin><![CDATA[
    /* --- BLOGGER RESET --- */
    .content-outer, .content-fauxcolumn-outer, .region-inner { 
        min-width: 0 !important; max-width: none !important; margin: 0 !important; padding: 0 !important; 
    }
    .navbar { display: none !important; }

    :root {
        --primary: #1a73e8;
        --primary-v: #1557b0;
        --bg: #f8f9fa;
        --text: #202124;
        --border: #dadce0;
    }

    body {
        margin: 0; padding: 0;
        width: 100vw; height: 100vh;
        overflow: hidden;
        background-color: var(--bg);
        font-family: 'Inter', sans-serif;
        display: flex;
        flex-direction: column; 
    }

    #control-panel {
        background-color: #fff;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        z-index: 100;
        max-height: 45vh;
        overflow-y: auto;
    }

    body.embed-mode #control-panel { display: none !important; }
    #edit-toggle { display: none !important; }

    .panel-title { font-family: 'Outfit', sans-serif; font-size: 18px; color: var(--primary); margin: 0; }

    .input-grp label { display: block; font-weight: 600; font-size: 13px; color: var(--text); margin-bottom: 5px; }

    textarea, input[type="text"] {
        width: 100%;
        padding: 9px;
        border: 1px solid var(--border);
        border-radius: 8px;
        box-sizing: border-box;
        font-family: 'Consolas', monospace;
        font-size: 11px;
        background: #fafafa;
    }
    
    #json-input { min-height: 80px; resize: vertical; }

    .out-section { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
    .out-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .out-row button { padding: 8px 14px; font-size: 12px; font-weight: 500; cursor: pointer; border-radius: 6px; }

    #gen-btn { 
        width: 100%; background-color: var(--primary); color: white; padding: 11px; 
        border: none; border-radius: 8px; font-weight: 600; cursor: pointer; 
    }
    #gen-btn:hover { background-color: var(--primary-v); }

    .btn-s { background-color: #f1f3f4; color: var(--text); border: 1px solid var(--border); }
    .btn-s:hover { background-color: #e8eaed; }
    .btn-a { background-color: #34a853; color: white; border: none; }

    #loading-overlay {
        display: none;
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.9);
        z-index: 999;
        align-items: center; justify-content: center;
        flex-direction: column;
    }
    .spinner {
        border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
        border-radius: 50%; width: 40px; height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #mindmap { flex-grow: 1; position: relative; overflow: hidden; background-color: var(--bg); width: 100%; height: 100%; touch-action: none; }
    
    .controls { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 110; }
    .btn-z { width: 42px; height: 42px; border-radius: 50%; background: white; color: #555; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    .node rect { fill: #fff; stroke: #e0e0e0; stroke-width: 1.5px; rx: 8px; ry: 8px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.05)); transition: all 0.3s; }
    .node:hover rect { stroke: var(--primary); stroke-width: 2px; }
    .node text { font-size: 14px; fill: var(--text); font-weight: 500; pointer-events: none; font-family: 'Inter', sans-serif; }
    .link { fill: none; stroke: #bbc1c9; stroke-width: 2px; opacity: 0.6; }
    .ind-c { fill: #fff; stroke: var(--primary); stroke-width: 1.5px; }
    .ind-t { font-size: 12px; fill: var(--primary); font-weight: bold; text-anchor: middle; alignment-baseline: middle; pointer-events: none; }
  ]]></b:skin>
</head>

<body>
  <div id='loading-overlay'>
      <div class='spinner'/>
      <p style='margin-top:10px; font-weight:600; color:#555;'>Processing Map Data...</p>
  </div>
  
  <a href='#' id='edit-toggle' onclick='toggleEditMode(); return false;'>&#9998; Edit</a>

  <div id='control-panel'>
      <div style='display:flex; justify-content:space-between; align-items:center;'>
          <h1 class='panel-title'>Mind Map Generator</h1>
          <span style='font-size:10px; color:#999;'>Student Free Edition</span>
      </div>

      <div class='input-grp'>
          <label for='json-input'>1. Map JSON Data:</label>
          <textarea id='json-input' placeholder='Paste JSON here...' spellcheck='false'/>
      </div>
      
      <button id='gen-btn' onclick='generateMindMap()'>Generate Study Map</button>
      <div id='error-message' style='color: #d93025; font-size: 12px; margin-top: 5px; font-weight:bold;'/>
      
      <div class='out-section' id='outputs'>
          <div class='input-grp'>
              <label>2. Permanent Share Link:</label>
              <div class='out-row'>
                  <input id='share-link' readonly='readonly' type='text'/>
                  <button class='btn-s' onclick='copyText(&quot;share-link&quot;)'>Copy</button>
                  <button class='btn-s' onclick='window.open(document.getElementById(&quot;share-link&quot;).value, &quot;_blank&quot;)'>Open</button>
              </div>
          </div>

          <div class='input-grp'>
              <label>3. Offline Access:</label>
              <div class='out-row'>
                  <button class='btn-a' onclick='downloadImage()' style='width:100%'>Download Map as Image (PNG)</button>
              </div>
              <input id='embed-code' type='hidden'/>
          </div>
      </div>
  </div>

  <div id='mindmap'>
      <div class='controls'>
          <button class='btn-z' onclick='zoomIn()'>+</button>
          <button class='btn-z' onclick='zoomOut()'>-</button>
          <button class='btn-z' onclick='fitToScreen()'>&#9974;</button>
      </div>
  </div>

  <script>
  //<![CDATA[
    let root, svg, g, zoom, treemap;
    let i = 0, duration = 600;
    
    function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
    function copyText(id) {
        const el = document.getElementById(id);
        el.select();
        document.execCommand('copy');
        alert("Copied to clipboard!");
    }

    function generateMindMap() {
        showLoading(true);
        const jsonInput = document.getElementById('json-input'), errorMsg = document.getElementById('error-message'), outputDiv = document.getElementById('outputs');
        errorMsg.textContent = '';
        setTimeout(() => {
            try {
                const rawVal = jsonInput.value.trim();
                if(!rawVal) throw new Error("Please enter JSON data.");
                let data = JSON.parse(rawVal);
                renderGraph(data);
                generateShareLinks(rawVal); 
                outputDiv.style.display = 'block';
            } catch(e) {
                errorMsg.textContent = e.message;
            } finally {
                showLoading(false);
            }
        }, 100);
    }

    function generateShareLinks(jsonString) {
        const compressed = LZString.compressToEncodedURIComponent(jsonString);
        let baseUrl = window.location.origin + window.location.pathname;
        if (baseUrl.endsWith('index.html')) baseUrl = baseUrl.replace('index.html', '');
        if (!baseUrl.endsWith('/')) baseUrl += '/';
        const permLink = `${baseUrl}#map=${compressed}&embed=true`;
        document.getElementById('share-link').value = permLink;
        document.getElementById('embed-code').value = `<iframe src="${permLink}" width="100%" height="600px" style="border:1px solid #ddd; border-radius:8px;"></iframe>`;
    }

    function toggleEditMode() {
        document.body.classList.remove('embed-mode');
        history.pushState(null, null, window.location.href.split('&embed=true')[0]);
    }

    function renderGraph(data) {
        d3.select("#mindmap").select("svg").remove();
        const container = document.getElementById('mindmap'), w = container.clientWidth, h = container.clientHeight;
        svg = d3.select("#mindmap").append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${w} ${h}`).call(d3.zoom().on("zoom", null));
        g = svg.append("g");
        zoom = d3.zoom().scaleExtent([0.1, 3]).on("zoom", (e) => g.attr("transform", e.transform));
        svg.call(zoom);
        treemap = d3.tree().nodeSize([70, 250]);
        root = d3.hierarchy(data, d => d.children);
        root.x0 = 0; root.y0 = 0;
        if (root.children) root.children.forEach(collapse);
        update(root);
        setTimeout(() => fitToScreen(), 200);
    }

    function collapse(d) {
        if(d.children) { d._children = d.children; d._children.forEach(collapse); d.children = null; }
    }

    function update(source) {
        const treeData = treemap(root), nodes = treeData.descendants(), links = treeData.descendants().slice(1);
        nodes.forEach(d => { d.y = d.depth * 280; });
        const node = g.selectAll('g.node').data(nodes, d => d.id || (d.id = ++i));
        const nodeEnter = node.enter().append('g').attr('class', 'node').attr('transform', d => `translate(${source.y0},${source.x0})`).on('click', click);
        const getName = (d) => d.data.name || "Topic";
        nodeEnter.append('text').attr("dy", ".35em").attr("text-anchor", "middle").text(d => getName(d));
        nodeEnter.insert('rect', 'text').each(function(d) {
            const width = Math.max(120, getName(d).length * 9 + 40);
            d3.select(this).attr("width", width).attr("height", 44).attr("x", -width/2).attr("y", -22).attr("rx",10).attr("ry",10);
        });
        const indicators = nodeEnter.append("g").attr("class", "ind-g").style("opacity", 0);
        indicators.append("circle").attr("class", "ind-c").attr("r", 9).attr("cx", d => (Math.max(120, getName(d).length * 9 + 40)/2));
        indicators.append("text").attr("class", "ind-t").attr("dy", 1).attr("dx", d => (Math.max(120, getName(d).length * 9 + 40)/2)).text(d => d.children ? "−" : "+");
        const nodeUpdate = node.merge(nodeEnter).transition().duration(duration).attr('transform', d => `translate(${d.y},${d.x})`);
        nodeUpdate.select(".ind-g").style("opacity", d => (d.children || d._children) ? 1 : 0);
        nodeUpdate.select(".ind-t").text(d => d.children ? "−" : "+");
        node.exit().transition().duration(duration).attr('transform', d => `translate(${source.y},${source.x})`).remove();
        const link = g.selectAll('path.link').data(links, d => d.id);
        const linkEnter = link.enter().insert('path', "g").attr("class", "link").attr('d', d => { const o = {x: source.x0, y: source.y0}; return diagonal(o, o); });
        link.merge(linkEnter).transition().duration(duration).attr('d', d => diagonal(d, d.parent));
        link.exit().transition().duration(duration).remove();
        nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
    }

    function diagonal(s, d) { return `M ${s.y} ${s.x} C ${(s.y + d.y)/2} ${s.x}, ${(s.y + d.y)/2} ${d.x}, ${d.y} ${d.x}`; }
    function click(e, d) {
        if(d.children) { d._children = d.children; d.children = null; } 
        else { d.children = d._children; d._children = null; }
        update(d); centerNode(d);
    }

    function centerNode(source) {
        const t = d3.zoomTransform(svg.node()), w = document.getElementById('mindmap').clientWidth, h = document.getElementById('mindmap').clientHeight;
        const x = -source.y * t.k + (w < 600 ? w/4 : w/3), y = -source.x * t.k + h/2;
        svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(t.k));
    }
    function fitToScreen() {
        const w = document.getElementById('mindmap').clientWidth, h = document.getElementById('mindmap').clientHeight;
        svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(w/8, h/2).scale(0.8));
    }
    function zoomIn() { svg.transition().call(zoom.scaleBy, 1.3); }
    function zoomOut() { svg.transition().call(zoom.scaleBy, 0.7); }

    function downloadImage() {
        htmlToImage.toPng(document.getElementById('mindmap'))
            .then(function (dataUrl) {
                const link = document.createElement('a');
                link.download = 'study-mindmap.png';
                link.href = dataUrl;
                link.click();
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const example = { "name": "Study Topic", "children": [{ "name": "Part 1" }, { "name": "Part 2" }] };
        const jsonBox = document.getElementById('json-input'), hash = window.location.hash;
        if (hash.includes("embed=true")) document.body.classList.add('embed-mode');
        if (hash.includes("#map=")) {
            try {
                const compressed = hash.split("map=")[1].split("&")[0], decompressed = LZString.decompressFromEncodedURIComponent(compressed);
                if (decompressed) {
                    jsonBox.value = decompressed;
                    let check = setInterval(() => { if (typeof d3 !== 'undefined') { clearInterval(check); generateMindMap(); } }, 100);
                    return;
                }
            } catch (e) {}
        }
        jsonBox.value = JSON.stringify(example, null, 2);
        generateMindMap();
    });
  //]]>
  </script>
  <b:section id='main_app_container' showaddelement='no'/>
</body>
</html>
